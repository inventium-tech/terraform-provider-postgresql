name: ff-merge-labeler
run-name: 'üîÄ FF Merge Labeler - ${{ github.ref_name }}'

on:
  pull_request: # Trigger action only on pull-requests
    types:
      - synchronize
      - opened
      - reopened

permissions:
  contents: read

jobs:
  check_ffmerge:
    name: Check Fast-Forwardness
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    outputs:
      ff_merge: ${{ steps.ff_merge_check.outputs.ff_merge }}
    steps:
      - name: Checkout üíª
        uses: actions/checkout@v4.1.7
        with:
          fetch-depth: 0

      - name: Check Fast-Forwardness üîç
        id: ff_merge_check
        shell: bash
        run: |
          BASE_BRANCH='${{ github.base_ref }}'
          HEAD_BRANCH='${{ github.event.pull_request.head.ref }}'
          
          MERGE_BASE_REF=$(git merge-base origin/$HEAD_BRANCH origin/$BASE_BRANCH)
          REV_PARSE_BASE_REF=$(git rev-parse origin/$BASE_BRANCH)
          
          if [ $MERGE_BASE_REF == $REV_PARSE_BASE_REF ]; then
            echo "This PR is fast-forwardable."
            echo "ff_merge=1" >> $GITHUB_OUTPUT
          else
            echo "This PR is not fast-forwardable. Please rebase your branch."
            echo "ff_merge=0" >> $GITHUB_OUTPUT
          fi;

  toggle_ff_label:
    name: Toggle Fast-Forward Merge Label
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    needs: check_ffmerge
    if: ${{ success() }}
    steps:
      - name: Set Label üè∑Ô∏è
        uses: actions/github-script@v7.0.1
        id: ff-merge-label
        with:
          script: |
            console.info('GH_CONTEXT_EVENT_PULL_REQUEST:', {${{ fromJSON(fromgithub.event.pull_request) }}});
            const prNumber = context.issue.number;

            if ('${{ needs.check_ffmerge.outputs.ff_merge }}' === '0') {
              await github.rest.pulls.removeLabel({
                'owner': context.repo.owner,  // The account owner of the repository
                'repo': context.repo.repo,    // The name of the repository without the .git extension
                'issue_number': prNumber,     // The number that identifies the issue (PR)
                'name': 'ff-merge'            // The name of label to remove from to the issue (PR)
              });
              console.log("Fast-Forward Merge label remvoed from PR #", ${{ github.event.pull_request.number }});

            } else {
              await github.rest.issues.addLabels({
                'owner': context.repo.owner,  // The account owner of the repository
                'repo': context.repo.repo,    // The name of the repository without the .git extension
                'issue_number': prNumber,     // The number that identifies the issue (PR)
                'labels': ['ff-merge']        // The label to add to the issue (PR)
              });

              console.log("Fast-Forward Merge label added to PR #", ${{ github.event.pull_request.number }});
            }
