name: ff-merge-labeler
run-name: 'üîÄ FF Merge Labeler - PR #${{ github.event.pull_request.number }}'

on:
  pull_request: # Trigger action only on pull-requests
    types:
      - synchronize
      - opened
      - reopened

permissions:
  contents: read

jobs:
  check_ffmerge:
    name: Check Fast-Forwardness
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    outputs:
      ff_merge: ${{ steps.ff_merge_check.outputs.ff_merge }}
    steps:
      - name: Checkout üíª
        uses: actions/checkout@v4.1.7
        with:
          fetch-depth: 0

      - name: Check Fast-Forwardness üîç
        id: ff_merge_check
        shell: bash
        run: |
          BASE_BRANCH='${{ github.base_ref }}'
          HEAD_BRANCH='${{ github.event.pull_request.head.ref }}'
          
          MERGE_BASE_REF=$(git merge-base origin/$HEAD_BRANCH origin/$BASE_BRANCH)
          REV_PARSE_BASE_REF=$(git rev-parse origin/$BASE_BRANCH)
          
          if [ $MERGE_BASE_REF == $REV_PARSE_BASE_REF ]; then
            echo "This PR is fast-forwardable."
            echo "ff_merge=1" >> $GITHUB_OUTPUT
          else
            echo "This PR is not fast-forwardable. Please rebase your branch."
            echo "ff_merge=0" >> $GITHUB_OUTPUT
          fi;

  toggle_ff_label:
    name: Toggle Fast-Forward Merge Label
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    needs: check_ffmerge
    if: ${{ success() }}
    steps:
      - name: Add Label üè∑Ô∏è
        uses: actions/github-script@v7.0.1
        if: ${{ needs.check_ffmerge.outputs.ff_merge == '1' }}
        with:
          script: |
            console.info('CONTEXT_ISSUE:', `${context.issue}`);
            console.info('Add Fast-Forward Merge Label for PR:', '${{ github.event.pull_request.url }}');
            await github.rest.issues.addLabels({
              'owner': context.repo.owner,          // The account owner of the repository
              'repo': context.repo.repo,            // The name of the repository without the .git extension
              'issue_number': context.issue.number, // The number that identifies the issue (PR)
              'labels': ['ff-merge']                // The label to add to the issue (PR)
            });

            console.log("Fast-Forward Merge label added in PR:", '${{ github.event.pull_request.url }}');

      - name: Remove Label üè∑Ô∏è
        uses: actions/github-script@v7.0.1
        if: ${{ needs.check_ffmerge.outputs.ff_merge == '0' }}
        with:
          script: |
            console.info('Remove Fast-Forward Merge Label for PR:', '${{ github.event.pull_request.url }}');
            await github.rest.pulls.removeLabel({
              'owner': context.repo.owner,          // The account owner of the repository
              'repo': context.repo.repo,            // The name of the repository without the .git extension
              'issue_number': context.issue.number, // The number that identifies the issue (PR)
              'name': 'ff-merge'                    // The name of label to remove from to the issue (PR)
            });

            console.log("Fast-Forward Merge label removed in PR:", '${{ github.event.pull_request.url }}');
